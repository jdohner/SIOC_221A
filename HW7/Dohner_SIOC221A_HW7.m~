% file SIOC 221A HW 7
% 
% author Julia Dohner
%
% due date November 21, 2017
%
% I certify that this represents my own work and that I have not worked
% with classmates or other individuals to compelte this assignment. -JLD

clear all; close all;

% TODO: rename air temp and sea temp as T0 and Ta

%% inspect the data

% create empty arrays to hold time and temp data
time = [];
swTemp = [];
airTemp = [];

% time is 04/21/2015 to 06/22/2016
time = [time; ncread(strcat('OS_Stratus_2015_D_M.nc'),'TIME')];
swTemp = [swTemp; ncread(strcat('OS_Stratus_2015_D_M.nc'),'TEMP')];
airTemp = [airTemp; ncread(strcat('OS_Stratus_2015_D_M.nc'),'AIRT')];

% examining the time increments between adjacent measurements
t_diff = diff(time);
minDiff = min(t_diff); 
maxDiff = max(t_diff);
plot(t_diff);
% after plotting the values, I see that the t_diff values range between
% 0.0006944444 and 0.00069444452. The differences are sufficiently small
% to proceed with the Fourier transform.

% checking for NaN's in data:
numNaNsw = sum(isnan(swTemp(:)));
numNaNair = sum(isnan(airTemp(:)));

% plot the time series
date0=datenum(1950,1,1); % give reference date (first date)
time2 = double(time)+date0; 
figure('name','Seawater and Air Temperatures');
plot(time2, swTemp, '-b','LineWidth',1);
hold on
plot(time2, airTemp, '-r','LineWidth',1);

set(gca,'FontSize',16);
title('Stratus Seawater and Air Temperatures 04/21/2015 to 06/22/2016');
xlabel('Date');
datetick('x','mm/dd/yy')
ylabel('^{\circ}C');
legend('\fontsize{12}Sea', '\fontsize{12}Air');

%% compute the spectra for T0 and Ta

% lecture 7 is good for this

% data is taken every minute (86400 (seconds in a day)*t_diff = ~60 secs)
% split into 2 chunks to resolve seasonal cycle
M = 2; % number of segments splitting data into
N = 2*floor(length(time)/4); % length of each chunk of data (aka segment 
% length,  making sure divisible by 4)

% split into segments
swTemp2 = reshape(swTemp(1:N*2),N,M);
airTemp2 = reshape(airTemp(1:N*2),N,M);
% don't need to do overlapping segments

% apply Hanning window
swTemp2 = detrend(swTemp2).*(hann(length(swTemp2(:,1)))*ones(1,M));
airTemp2 = detrend(airTemp2).*(hann(length(airTemp2(:,1)))*ones(1,M));
% compute fft
swTemp2 = fft(swTemp2);
airTemp2 = fft(airTemp2);
% compute squared amplitude for half of fft
swTemp_amp = (abs(swTemp2(1:length(swTemp2)/2+1,:)).^2);
airTemp_amp = (abs(airTemp2(1:length(airTemp2)/2+1,:)).^2);
% multiply by a factor of 2
swTemp_amp = 2.*swTemp_amp;
airTemp_amp = 2.*airTemp_amp;
% normalize
T = length(airTemp2)/1440; % total time in days in each segment (1440 mins/day)
normalizationFactor = T/(N^2);
swTemp_amp = swTemp_amp.*normalizationFactor;
airTemp_amp = airTemp_amp.*normalizationFactor;
% average multiple segments
swTemp2_mean = mean(swTemp_amp,2);
airTemp2_mean = mean(airTemp_amp,2);
% get an uncertainty estimate
nu = 2*3; % DOF = 2*number of segments
err_high_pressure = nu/chi2inv(0.05/2,nu);
err_low_pressure = nu/chi2inv(1-0.05/2,nu);
ratio_chi2_pressure = err_high_pressure/err_low_pressure;

% plot
figure
semilogy(frequency,swTemp2_mean, '-b', [10 10],[err_low_pressure err_high_pressure]*pressure_sub3mean(1000), '-r');
xlabel('\fontsize{14}cycles per day')
ylabel('\fontsize{14}dbar^{2}/cpd')
title('\fontsize{16}Spectrum of 2015 Scripps Pier Pressure');
legend('\fontsize{12}Pier Pressure','\chi^{2}-computed Uncertainty');
